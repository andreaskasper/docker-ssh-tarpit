# Example: Deploy SSH Tarpit with Traefik monitoring
# This example shows how to integrate the tarpit with your existing Traefik setup

version: '3.8'

services:
  ssh-tarpit:
    image: andreaskasper/ssh-tarpit:latest
    container_name: ssh-tarpit
    restart: unless-stopped
    
    # Expose SSH tarpit on port 22
    ports:
      - "22:22"
    
    # Configuration
    environment:
      - BIND_ADDRESS=0.0.0.0
      - BIND_PORT=22
      - VERBOSE=info
      - MAX_CLIENTS=4096
    
    # Resource limits to prevent abuse
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 64M
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    
    # Traefik labels (SSH doesn't use HTTP, but we can monitor the container)
    labels:
      - "traefik.enable=false"  # SSH is not HTTP traffic
      - "com.centurylinklabs.watchtower.enable=true"  # Auto-update with Watchtower
    
    networks:
      - monitoring
    
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  monitoring:
    external: true

# Note: Make sure your real SSH server is on a different port!
# Edit /etc/ssh/sshd_config:
#   Port 2222
# Then restart: sudo systemctl restart sshd